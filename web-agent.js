"use strict";(()=>{var p=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var q=p(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.escapeRegExp=void 0;var le=/[-[\]{}()*+?.,\\^$|#\s]/g;function ue(s){return s.replace(le,"\\$&")}_.escapeRegExp=ue});var V=p(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.getOrExpr=void 0;var fe=q();function pe(s){return s.sort((e,t)=>t.length-e.length).map(fe.escapeRegExp).join("|")}b.getOrExpr=pe});var H=p(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.getPatternRe=void 0;var ge=V();function he(s){return new RegExp((0,ge.getOrExpr)([...s,"base"]),"g")}v.getPatternRe=he});var K=p(E=>{"use strict";Object.defineProperty(E,"__esModule",{value:!0});E.parsePattern=void 0;function me(s,e){let t=e.split(" ").filter(i=>!!i),r=0;return t.map(i=>{let a=i.match(s);if(a){if(a.length>1)throw Error(`pattern: segment '${i}' cannot represent both '${a[0]}' and '${a[1]}'`);let o=a[0];r+=1;let[d,g]=i.split(o);return{key:o,optional:o!=="base",prefix:d,postfix:g,matchIndex:r}}return{value:i,optional:!1,prefix:"",postfix:""}})}E.parsePattern=me});var G=p(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.Pattern=void 0;var Me=H(),ye=K(),A=class{segments;variableSegments;constructor(e,t){let r=(0,Me.getPatternRe)(e);this.segments=(0,ye.parsePattern)(r,t),this.variableSegments=this.segments.filter(n=>typeof n.key=="string"&&typeof n.matchIndex=="number")}};x.Pattern=A});var J=p(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.getClassRegExpString=void 0;var Q=q();function Se(s,e,t){return s.map(n=>{if(typeof n.key!="string")return`(?:${(0,Q.escapeRegExp)(n.value||"")||""})`;let a=(n.key==="base"?t:e[n.key]).sort((g,m)=>m.length-g.length).join("|"),o=(0,Q.escapeRegExp)(n.prefix||""),d=(0,Q.escapeRegExp)(n.postfix||"");return`(?:${o}(${a})${d})${n.optional?"?":""}`}).join("")}w.getClassRegExpString=Se});var X=p(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.parseClass=void 0;function _e(s,e,t){let r=t.match(s);if(!r)return null;let n={};for(let i=0;i<e.length;i+=1)n[e[i].key]=r[e[i].matchIndex]||"";return n}C.parseClass=_e});var Y=p(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});R.getMediaQueryString=void 0;function be(s,e){let t="",r,n=new Set;e.sort((a,o)=>s[a].index-s[o].index);for(let a=0;a<e.length;a+=1){if(!s[e[a]])throw new Error(`Modifier '${e[a]}' is not defined`);let o=s[e[a]].media;if(!o)continue;let d=o.mediaType;if(t&&d&&t!==d)throw new Error(`Modifiers '${r}' and '${e[a]}' can't be used together: conflicting media types`);d&&(t=d,r=e[a]);for(let g=0;g<o.mediaFeatures.length;g+=1)n.add(o.mediaFeatures[g])}let i=Array.from(n).join(" and ");return`${t?t+" and ":""}${i}`}R.getMediaQueryString=be});var Z=p($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.parseMedia=void 0;function ve(s){let e=s.match(/^\s*(?:(?:(only|not)\s+)?(screen|print|all|speech)(?:\s+and)?\s*)?(\(.+\))?\s*$/);if(!e)throw new Error(`Media query has incorrect format: '${s}'`);return{mediaType:[e[1],e[2]].filter(t=>t).join(" "),mediaFeatures:e[3]?e[3].split(/\s*and\s*/):[]}}$.parseMedia=ve});var ee=p(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});var Ee=Y(),xe=Z(),z=class{modifiersCfg;modifierMap;compareModifiers;constructor(e){this.modifiersCfg=e;let t=e?Object.keys(e):[];if(e){let r=0;this.modifierMap=t.reduce((n,i)=>{if(!e)return n;let a=e[i];return Object.keys(a).forEach(o=>{let d=a[o];n[o]={leftSide:d.leftSide,rightSide:d.rightSide,media:d.media?(0,xe.parseMedia)(d.media):void 0,index:r++}}),n},{})}else this.modifierMap={};this.compareModifiers=(r,n)=>this.modifierMap[r].index-this.modifierMap[n].index}has(e){return!!this.modifierMap[e]}compareModifierSets(e,t){if(e.length!==t.length)return e.length-t.length;let r=e.map(i=>this.getModifierIndex(i)).sort(),n=t.map(i=>this.getModifierIndex(i)).sort();for(let i=0;i<r.length;i+=1)if(r[i]!==n[i])return r[i]-n[i];return 0}isMediaModifier(e){return!!this.modifierMap[e].media}getRightSide(e){let t=this.modifierMap[e];return t&&t.rightSide||""}getLeftSide(e){let t=this.modifierMap[e];return t&&t.leftSide||""}getMediaQueryString(e){return(0,Ee.getMediaQueryString)(this.modifierMap,e)}getModifierIndex(e){return this.modifierMap[e].index}mergeModifiers(e,t){return Array.from(new Set([...e,...t])).sort(this.compareModifiers)}mergeSets(e,t){return new Set([...e,...t])}sortModifiers(e){return Array.from(e).sort(this.compareModifiers)}getModifierNames(e){if(this.modifiersCfg){let t=this.modifiersCfg.modifiers[e];if(t)return Object.keys(t)}throw new Error(`config.modifiers.${e} is not defined`)}};I.default=z});var te=p(j=>{"use strict";Object.defineProperty(j,"__esModule",{value:!0});j.ClassUsage=void 0;var F=class{className;modifierMap;isBase;modifierNames;base;constructor(e,t){this.className=e,this.modifierMap=t,this.base=this.modifierMap.base,this.modifierNames=new Set(Object.keys(this.modifierMap).filter(r=>r!=="base").map(r=>this.modifierMap[r]).filter(r=>r)),this.isBase=!this.modifierNames.size}};j.ClassUsage=F});var re=p(M=>{"use strict";var we=M&&M.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(M,"__esModule",{value:!0});var Ce=G(),Re=J(),$e=X(),je=we(ee()),Ne=te(),B=class{config;classDefMap;pattern;modStore;classParser;extractorRe;baseStyle;providers;constructor(e){this.config=e,this.baseStyle=e.baseStyle||"",this.modStore=new je.default(e.modifiers);let t=e.modifiers?Object.keys(e.modifiers):[];this.pattern=new Ce.Pattern(t,e.pattern),this.classDefMap={},this.providers=e.providers,this.updateRe()}updateRe(){let e=this.getClassRegExpString(),t=new RegExp(`^${e}$`);this.classParser=r=>{let n=(0,$e.parseClass)(t,this.getVariableSegments(),r);return n&&new Ne.ClassUsage(r,n)},this.extractorRe=new RegExp(e,"g")}getClassDefinition(e){if(this.classDefMap[e])return this.classDefMap[e];let t;for(let r=0;r<this.providers.length;r+=1)if(t=this.providers[r].getDefinition(e),t)return this.classDefMap[e]=t,t;throw new Error(`Class with base '${e}' is not defined`)}getPatternSegments(){return this.pattern.segments}getVariableSegments(){return this.pattern.variableSegments}getModifierNames(e){if(this.config.modifiers){let t=this.config.modifiers[e];if(t)return Object.keys(t)}throw new Error(`config.modifiers.${e} is not defined`)}getSegmentNames(e){return this.getModifierNames(e)}getSegmentNameMap(){return this.pattern.segments.reduce((e,t)=>(t.key&&t.key!=="base"&&(e[t.key]=this.getSegmentNames(t.key)),e),{})}getClassRegExpString(){return(0,Re.getClassRegExpString)(this.getPatternSegments(),this.getSegmentNameMap(),this.providers.reduce((e,t)=>(e.push(...t.getPatterns()),e),[]))}};M.default=B});var se=p(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.generateClassName=void 0;function Oe(s,e){return s.reduce((t,r)=>typeof r.key!="string"?`${t}${r.value||""}`:e[r.key]?`${t}${r.prefix}${e[r.key]}${r.postfix}`:t,"")}N.generateClassName=Oe});var ie=p(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.escapeCssSelector=void 0;var Pe=/[!"#$%&'()[\]{}*+,./:;<>=?@\\^`|~]/g;function ke(s){return s.replace(Pe,"\\$&")}O.escapeCssSelector=ke});var ne=p(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0});P.getDeclarations=void 0;function De(s){let e=s.entries(),t="";for(let r=e.next();!r.done;r=e.next())t+=`${r.value.join(":")};`;return t}P.getDeclarations=De});var ae=p(y=>{"use strict";var Te=y&&y.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(y,"__esModule",{value:!0});var qe=Te(re()),Ae=se(),Qe=ie(),ze=ne(),h=class{core;mediaQueues;renderedTaskSet;rulesetCache;baseStyle;constructor(e){this.core=new qe.default(e),this.mediaQueues=h.newMediaQueueMap(),this.rulesetCache={},this.renderedTaskSet=new Set,this.baseStyle=e.baseStyle||""}static newMediaQueueMap(){return{"":{medias:[],classRenderTasks:[]}}}compareMediaRenderTasks(e,t){return e.medias.length!==t.medias.length?e.medias.length-t.medias.length:this.core.modStore.compareModifierSets(e.medias,t.medias)}compareClassRenderTasks(e,t){return e.instance.declMap.size!==t.instance.declMap.size?t.instance.declMap.size-e.instance.declMap.size:e.modifiers.length!==t.modifiers.length?e.modifiers.length-t.modifiers.length:e.id.localeCompare(t.id)}buildMediaRenderTaskMap(e,t){return t.forEach(r=>{let n=this.core.getClassDefinition(r.base);n!==null&&n.instances.forEach(i=>{let a=Array.from(new Set([...i.modifierNames,...r.modifierNames])).filter(g=>this.core.modStore.isMediaModifier(g)).sort(),o=a.join("\\");e[o]||(e[o]={medias:a,classRenderTasks:[]});let d=`${o}\\${r.className}`;this.renderedTaskSet.has(d)||e[o].classRenderTasks.push({id:d,classUsage:r,instance:i,modifiers:this.core.modStore.mergeModifiers(r.modifierNames,i.modifierNames)})})}),Object.keys(e).map(r=>(e[r].classRenderTasks.sort(this.compareClassRenderTasks.bind(this)),e[r])).sort(this.compareMediaRenderTasks.bind(this))}_generateCss(e,t){let r=Array.from(new Set(t)).sort().map(i=>this.core.classParser(i)).filter(i=>i);return this.buildMediaRenderTaskMap(e,r).reduce((i,a)=>{let o=a.classRenderTasks;if(!o.length)return i;let d=a.medias,g=o.map(m=>this.getRuleSet(m));return d.length?`${i}@media ${this.core.modStore.getMediaQueryString(d)}{${g.join("")}}`:`${i}${g.join("")}`},"")}generateCss(e){return this._generateCss(h.newMediaQueueMap(),e)}updateCss(e){return this._generateCss(this.mediaQueues,e)}getClassSelector(e,t){let r=this.core.modStore.mergeModifiers(e.modifierNames,t.modifierNames),n=r.map(o=>this.core.modStore.getLeftSide(o)).join(""),i=r.map(o=>this.core.modStore.getRightSide(o)).join(""),a=(0,Qe.escapeCssSelector)((0,Ae.generateClassName)(this.core.getPatternSegments(),e.modifierMap));return`${n}.${a}${i}`}getDeclarations(e){return(0,ze.getDeclarations)(e.declMap)}getRuleSet(e){if(!this.rulesetCache[e.id]){let{classUsage:t,instance:r}=e,n=this.getClassSelector(t,r),i=this.getDeclarations(r);this.rulesetCache[e.id]=`${n}{${i}}`}return this.rulesetCache[e.id]}};y.default=h});var oe=p(S=>{"use strict";var Ie=S&&S.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(S,"__esModule",{value:!0});var Fe=Ie(ae());S.default=s=>{let e=performance.now(),t=new Fe.default(s);console.log("bootstrapped in",performance.now()-e),performance.clearMarks(),performance.clearMeasures(),Object.assign(window,{perf:()=>{let u=performance.getEntriesByName("collect-classes").map(c=>c.duration),l=u.reduce((c,f)=>c+f,0);console.group("collect classes performance"),console.log("sum",l),console.log("avg",l/u.length),console.log(u),console.groupEnd(),u=performance.getEntriesByName("update-style").map(c=>c.duration),l=u.reduce((c,f)=>c+f,0),console.group("update style performance"),console.log("sum",l),console.log("avg",l/u.length),console.log(u),console.groupEnd(),performance.clearMarks(),performance.clearMeasures()}});let r={attributes:!0,attributeFilter:["class"],childList:!0,subtree:!0},n=new Set,i=[],a=document.getElementById("eco-style"),o=document.createElement("style");o.innerText=t.baseStyle,a&&a.parentElement?a.parentElement.insertBefore(o,a):document.head.appendChild(o);let d=a||document.createElement("style");a||document.head.appendChild(d);let g=u=>{performance.mark("collect-classes-start");let l=new Set;if(u){let c=document.createNodeIterator(u,NodeFilter.SHOW_ELEMENT);for(let f=c.nextNode();f;f=c.nextNode()){let W=f.getAttribute("class"),U=W&&W.split(/\s+/);U&&U.forEach(de=>{l.add(de)})}}return performance.measure("collect-classes","collect-classes-start"),l},m=u=>{let l=performance.now();performance.mark("update-style-start");let c=n.size;for(let f=0;f<u.length;f+=1)n.add(u[f]);n.size!==c&&(d.innerText=t.updateCss(u)),performance.measure("update-style","update-style-start"),console.log("updated style in",performance.now()-l,u)},D=!1,T=()=>{D||(D=!0,window.requestAnimationFrame(()=>{m(i),i.length=0,D=!1}))},ce=function(u){for(let l of u)if(l.type==="childList")for(let c=0;c<l.addedNodes.length;c+=1){let f=l.addedNodes[c];f.nodeType===Node.ELEMENT_NODE&&(i.push(...g(f)),i.length&&T())}else if(l.type==="attributes"&&l.attributeName==="class"){let c=l.target;if(c.nodeType!==Node.ELEMENT_NODE)continue;i.push(...c.className.trim().split(/\s+/)),i.length&&T()}},L=new MutationObserver(ce);if(document.body)L.observe(document.body,r),i.push(...g(document.body)),i.length&&T();else{let u=new MutationObserver(l=>{for(let c=0;c<l.length;c+=1)if(l[c].addedNodes){for(let f=0;f<l[c].addedNodes.length;f+=1)if(l[c].addedNodes[f]===document.body){L.observe(document.body,r),u.disconnect();return}}});u.observe(document.children[0],{childList:!0})}return t}});var We=p(k=>{var Be=k&&k.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(k,"__esModule",{value:!0});var Le=Be(oe());window.EcoCss={startWebAgent:Le.default}});We();})();
//# sourceMappingURL=web-agent.js.map
